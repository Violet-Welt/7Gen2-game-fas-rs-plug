name: è‡ªåŠ¨æ‰“åŒ…Magiskæ¨¡å—
on:
  push:
    tags:
      - 'v*' # æ¨é€vå¼€å¤´çš„æ ‡ç­¾è‡ªåŠ¨æ‰“åŒ…+å‘å¸ƒï¼ˆv1.0ã€v1.1ï¼‰
  workflow_dispatch: # æ”¯æŒç½‘é¡µæ‰‹åŠ¨ä¸€é”®è§¦å‘æ‰“åŒ…ï¼ˆæµ‹è¯•ç”¨ï¼‰
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆç‰ˆæœ¬å·ä¸ZIPåç§°
        id: get_info
        run: |
          # æå–ç‰ˆæœ¬å·ï¼Œå’Œä½ æˆªå›¾çš„å‘½åæ ¼å¼å®Œå…¨åŒ¹é…
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            ZIP_NAME="7gen2-fas-rs-plug-v${VERSION}.zip"
          else
            VERSION="test-$(date +%Y%m%d)"
            ZIP_NAME="7gen2-fas-rs-plug-${VERSION}.zip"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_OUTPUT

      - name: ğŸ” å‰ç½®æ ¡éªŒï¼šæ ¸å¯¹æ‰€æœ‰å¿…é¡»æ–‡ä»¶
        run: |
          echo "===== å½“å‰ä»“åº“æ ¹ç›®å½•æ–‡ä»¶åˆ—è¡¨ ====="
          ls -la
          echo "===== moduleæ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶åˆ—è¡¨ ====="
          ls -la module/
          echo "==================================="
          
          # æ£€æŸ¥ä»“åº“æ ¹ç›®å½•çš„å¿…é¡»æ–‡ä»¶
          REQUIRED_ROOT=("module" "module.prop" "main.lua")
          for ITEM in "${REQUIRED_ROOT[@]}"; do
            if [ ! -e "$ITEM" ]; then
              echo "âŒ é”™è¯¯ï¼šä»“åº“æ ¹ç›®å½•ç¼ºå°‘å¿…é¡»æ–‡ä»¶/æ–‡ä»¶å¤¹ -> $ITEM"
              exit 1
            fi
          done

          # æ£€æŸ¥moduleæ–‡ä»¶å¤¹å†…çš„å¿…é¡»æ–‡ä»¶
          REQUIRED_MODULE=("META-INF" "customize.sh" "service.sh")
          for ITEM in "${REQUIRED_MODULE[@]}"; do
            if [ ! -e "module/$ITEM" ]; then
              echo "âŒ é”™è¯¯ï¼šmoduleæ–‡ä»¶å¤¹å†…ç¼ºå°‘å¿…é¡»æ–‡ä»¶/æ–‡ä»¶å¤¹ -> $ITEM"
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶æ ¡éªŒé€šè¿‡ï¼Œç›®å½•ç»“æ„æ­£ç¡®"

      - name: ğŸ“¦ å‡†å¤‡æ‰“åŒ…ç›®å½•ï¼ˆåˆå¹¶æ–‡ä»¶ï¼Œç¡®ä¿ç»“æ„æ­£ç¡®ï¼‰
        run: |
          # åˆ›å»ºä¸´æ—¶æ‰“åŒ…ç›®å½•ï¼Œæ‰€æœ‰è¦æ‰“åŒ…çš„æ–‡ä»¶éƒ½æ”¾è¿™é‡Œï¼Œæœ€ç»ˆZIPæ ¹ç›®å½•å°±æ˜¯è¿™é‡Œçš„å†…å®¹
          mkdir -p pack_temp
          
          # ç¬¬ä¸€æ­¥ï¼šæŠŠmoduleæ–‡ä»¶å¤¹é‡Œçš„æ‰€æœ‰å†…å®¹ï¼Œå¤åˆ¶åˆ°æ‰“åŒ…ç›®å½•æ ¹ç›®å½•
          cp -r module/* pack_temp/
          
          # ç¬¬äºŒæ­¥ï¼šæŠŠä»“åº“æ ¹ç›®å½•çš„æ ¸å¿ƒæ–‡ä»¶ï¼Œå¤åˆ¶åˆ°æ‰“åŒ…ç›®å½•æ ¹ç›®å½•
          # å¦‚æœä½ æœ‰å…¶ä»–æ ¹ç›®å½•æ–‡ä»¶è¦æ‰“åŒ…ï¼Œåœ¨è¿™é‡ŒåŠ ä¸€è¡Œå³å¯ï¼Œæ ¼å¼ï¼šcp æ–‡ä»¶å pack_temp/
          cp module.prop pack_temp/
          cp main.lua pack_temp/
          # æ¯”å¦‚ä½ è¦æ‰“åŒ…update.jsonï¼Œå°±æŠŠä¸‹é¢è¿™è¡Œçš„#å»æ‰
          # cp update.json pack_temp/

          echo "===== æœ€ç»ˆæ‰“åŒ…ç›®å½•çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆå’Œä½ æˆªå›¾çš„ZIPç»“æ„å®Œå…¨ä¸€è‡´ï¼‰ ====="
          ls -la pack_temp/
          echo "=================================================================="

      - name: ğŸ“¦ æ‰§è¡Œæ‰“åŒ…ï¼ˆå’Œä½ æ‰‹åŠ¨æ‰“åŒ…çš„ç»“æ„å®Œå…¨ä¸€è‡´ï¼‰
        run: |
          # è¿›å…¥æ‰“åŒ…ç›®å½•ï¼Œæ‰“åŒ…æ‰€æœ‰å†…å®¹ï¼Œç¡®ä¿ZIPæ ¹ç›®å½•å°±æ˜¯è¿™äº›æ–‡ä»¶ï¼Œæ²¡æœ‰å¤šä½™æ–‡ä»¶å¤¹
          cd pack_temp
          zip -r "../${{ steps.get_info.outputs.ZIP_NAME }}" ./*
          cd ..
          echo "âœ… æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶åï¼š${{ steps.get_info.outputs.ZIP_NAME }}"

      - name: ğŸ” æ‰“åŒ…ç»“æœæœ€ç»ˆæ ¡éªŒ
        run: |
          echo "===== æ‰“åŒ…åZIPå†…çš„å®Œæ•´æ–‡ä»¶åˆ—è¡¨ ====="
          unzip -l "${{ steps.get_info.outputs.ZIP_NAME }}"
          echo "======================================="
          
          # äºŒæ¬¡æ ¡éªŒZIPå†…çš„æ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶ï¼Œç¡®ä¿éƒ½åœ¨æ ¹ç›®å½•
          ZIP_FILE="${{ steps.get_info.outputs.ZIP_NAME }}"
          REQUIRED_IN_ZIP=("META-INF" "module.prop" "customize.sh" "main.lua" "service.sh")
          for ITEM in "${REQUIRED_IN_ZIP[@]}"; do
            if ! unzip -l "$ZIP_FILE" | grep -q "$ITEM"; then
              echo "âŒ é”™è¯¯ï¼šZIPå†…ç¼ºå°‘æ–‡ä»¶ -> $ITEM"
              exit 1
            fi
          done
          echo "âœ… æ ¡éªŒé€šè¿‡ï¼ZIPå†…ç»“æ„å’Œä½ æˆªå›¾çš„æ­£å¸¸æ¨¡å—å®Œå…¨ä¸€è‡´ï¼Œå¯ç›´æ¥åˆ·å…¥"

      - name: ä¸Šä¼ æ‰“åŒ…æˆå“ï¼ˆå¯ç›´æ¥ä¸‹è½½æµ‹è¯•ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get_info.outputs.ZIP_NAME }}
          path: ${{ steps.get_info.outputs.ZIP_NAME }}

      - name: è‡ªåŠ¨å‘å¸ƒåˆ°Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.get_info.outputs.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
