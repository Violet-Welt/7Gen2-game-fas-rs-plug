name: è‡ªåŠ¨æ‰“åŒ…å¹¶å‘å¸ƒMagiskæ¨¡å—
on:
  push:
    tags:
      - 'v*' # æ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è‡ªåŠ¨æ‰“åŒ…å¹¶å‘å¸ƒ (ä¾‹å¦‚: v1.0, v1.1)
  workflow_dispatch: # æ”¯æŒåœ¨GitHubç½‘é¡µä¸Šæ‰‹åŠ¨è§¦å‘æ‰“åŒ…

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: get_version
        run: |
          # ä»Gitæ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·ï¼Œå¦‚ v1.0 -> 1.0
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            MODULE_VERSION=${GITHUB_REF#refs/tags/v}
          else
            MODULE_VERSION="æµ‹è¯•ç‰ˆ-$(date +%Y%m%d%H%M%S)"
          fi
          # å®šä¹‰æœ€ç»ˆçš„ZIPåŒ…åç§°
          MODULE_ZIP_NAME="7gen2-fas-rs-plug-${MODULE_VERSION}.zip"
          
          echo "MODULE_VERSION=${MODULE_VERSION}" >> $GITHUB_OUTPUT
          echo "MODULE_ZIP_NAME=${MODULE_ZIP_NAME}" >> $GITHUB_OUTPUT

      - name: 3. ğŸ” æ ¡éªŒæ ¸å¿ƒæ–‡ä»¶ (å…³é”®æ­¥éª¤)
        run: |
          echo "===== æ£€æŸ¥å½“å‰ç›®å½•ç»“æ„ ====="
          ls -la
          echo "=============================="
          
          # æ£€æŸ¥module.propæ˜¯å¦å­˜åœ¨äºæ ¹ç›®å½•
          if [ ! -f "module.prop" ]; then
            echo "âŒ é”™è¯¯ï¼šæ ¹ç›®å½•æœªæ‰¾åˆ° module.prop æ–‡ä»¶ï¼"
            exit 1
          fi
          
          # æ£€æŸ¥META-INFç›®å½•æ˜¯å¦å­˜åœ¨äºæ ¹ç›®å½•
          if [ ! -d "META-INF" ]; then
            echo "âŒ é”™è¯¯ï¼šæ ¹ç›®å½•æœªæ‰¾åˆ° META-INF æ–‡ä»¶å¤¹ï¼"
            exit 1
          fi
          
          echo "âœ… æ ¸å¿ƒæ–‡ä»¶æ ¡éªŒé€šè¿‡ï¼"

      - name: 4. ğŸ“¦ æ‰§è¡Œæ‰“åŒ… (ä¿®å¤ç‰ˆ)
        run: |
          # æ ¸å¿ƒå‘½ä»¤ï¼šæ‰“åŒ…å½“å‰ç›®å½•æ‰€æœ‰å†…å®¹ï¼Œæ’é™¤Gitå’Œå·¥ä½œæµæ–‡ä»¶
          zip -r "${{ steps.get_version.outputs.MODULE_ZIP_NAME }}" . \
            -x ".git/*" ".github/*" "README.md" "LICENSE" "*.md"
          
          echo "âœ… æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶åä¸ºï¼š${{ steps.get_version.outputs.MODULE_ZIP_NAME }}"

      - name: 5. ğŸ” éªŒè¯æ‰“åŒ…ç»“æœ
        run: |
          echo "===== ç”Ÿæˆçš„ZIPåŒ…å†…å®¹é¢„è§ˆ ====="
          unzip -l "${{ steps.get_version.outputs.MODULE_ZIP_NAME }}" | head -20
          echo "================================"
          
          # æ£€æŸ¥ZIPåŒ…å†…æ˜¯å¦åŒ…å«å…³é”®æ–‡ä»¶
          if unzip -l "${{ steps.get_version.outputs.MODULE_ZIP_NAME }}" | grep -q "module.prop"; then
            echo "âœ… éªŒè¯é€šè¿‡ï¼šZIPåŒ…å†…åŒ…å« module.prop"
          else
            echo "âŒ é”™è¯¯ï¼šZIPåŒ…å†…æœªæ‰¾åˆ° module.propï¼"
            exit 1
          fi

      - name: 6. ğŸ“¤ ä¸Šä¼ æ‰“åŒ…äº§ç‰© (ä¾›æ‰‹åŠ¨ä¸‹è½½)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get_version.outputs.MODULE_ZIP_NAME }}
          path: ${{ steps.get_version.outputs.MODULE_ZIP_NAME }}

      - name: 7. ğŸš€ è‡ªåŠ¨å‘å¸ƒåˆ°GitHub Release
        if: startsWith(github.ref, 'refs/tags/v') # ä»…åœ¨æ¨é€æ ‡ç­¾æ—¶æ‰§è¡Œ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: ${{ steps.get_version.outputs.MODULE_ZIP_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
